---
title: |
  ![](www/img/interactive_logo.png){width=120px align=left style="padding-right: 20px"}
  School Shootings in the United States
css: www/style.css
output:
  html_document:
    includes:
       in_header: www/GA_Script.Rhtml
    self_contained: yes
    code_download: yes
    highlight: tango
    number_sections: no
    theme: cosmo
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
runtime: shiny_prerendered
---

<!-- code for including logo in toc: -->
<!-- <style> -->
<!-- #TOC { -->
<!--   background: url("https://opencasestudies.github.io/img/icon-bahi.png"); -->
<!--   background-size: contain; -->
<!--   padding-top: 240px !important; -->
<!--   background-repeat: no-repeat; -->
<!-- } -->
<!-- </style> -->
<!-- (not working for interactive currently, needs to be investigated) -->

<!-- Open all links in new tab-->  
<base target="_blank"/>  

<div align="left" id="google_translate_element",></div>

<script type="text/javascript" src='//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit'></script>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
}
</script>


```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE, comment = NA, echo = TRUE,
                      message = FALSE, warning = FALSE, cache = FALSE,
                      fig.align = "center", out.width = '90%')
library(here)
library(knitr)

library(learnr)
library(gradethis)
gradethis::gradethis_setup()
```

We will begin by loading the packages that we will need:


```{r}
library(here)
library(readr)
library(googlesheets4)
library(tibble)
library(dplyr)
library(stringr)
library(magrittr)
library(tidyr)
library(ggmap)
library(sf)
library(lubridate)
library(DT)
library(htmltools)
library(ggplot2)
library(forcats)
library(ggforce)
library(waffle)
library(poliscidata)
library(flexdashboard)
library(shiny)
library(leaflet)
library(maps)
library(vembedr)
library(OCSdata)
```

# **Data Analysis and Visualization**
*** 

If you have been following along but stopped, we could load our data like so:
```{r, eval=FALSE}
load(here::here("data", "wrangled", "shooting_data_wrangled_pre_map.rda"))
load(here::here("data", "wrangled", "shooting_data_wrangled_for_map.rda"))

```

```{r, echo=FALSE}
load(here::here("www", "data", "wrangled", "shooting_data_wrangled_pre_map.rda"))
load(here::here("www", "data", "wrangled", "shooting_data_wrangled_for_map.rda"))

```

We need the wangled data that is prepared both for the map and the data just before the last wrangling step Geometry lists with the `sf` package] to prepare for the map because we removed some events that did not have addresses that were identified by Google (had `NA` values for latitude or longitude).  We want to use data for all events for our statistics, tables, and plots.

#### {.click_to_expand_block}

<details> <summary> If you skipped the previous sections click here. </summary>

First you need to install the `OCSdata` package:

```{r, eval=FALSE}
install.packages("OCSdata")
```

Then, you may download the wrangled data `.rda` files like so:

```{r, eval=FALSE}
# library(OCSdata)
wrangled_rda("ocs-bp-school-shootings-dashboard")
```

To load the downloaded data into your environment, you may double click on each of the `.rda` files in Rstudio or using the `load()` function.

If the package does not work for you, two RDA files (stands for R data) of the data can be found [here](https://github.com/opencasestudies/ocs-bp-school-shootings-dashboard/tree/master/data/wrangled) or slightly more directly [here](https://raw.githubusercontent.com/opencasestudies/ocs-bp-school-shootings-dashboard/master/data/wrangled/shooting_data_wrangled_for_map.rda) and [here](https://raw.githubusercontent.com/opencasestudies/ocs-bp-school-shootings-dashboard/master/data/wrangled/shooting_data_wrangled_pre_map.rda). Download these files and then place them in your current working directory. We recommend using an RStudio project and the [`here` package](https://github.com/jennybc/here_here) to navigate to your files more easily. 

We have put these files in a directory called "wrangled" within a directory called "data" within our working directory (which has a .Rproj file).

```{r, eval=FALSE}
load(here::here("data", "wrangled", "shooting_data_wrangled_pre_map.rda"))
load(here::here("data", "wrangled", "shooting_data_wrangled_for_map.rda"))

```

```{r, echo=FALSE}
load(here::here("www", "data", "wrangled", "shooting_data_wrangled_pre_map.rda"))
load(here::here("www", "data", "wrangled", "shooting_data_wrangled_for_map.rda"))

```

<hr style="height:1px;border:none;color:#333;background-color:#333;" />
<details> <summary> Click here to see more about creating new projects in RStudio. </summary>

You can create a project by going to the File menu of RStudio like so:


```{r, echo = FALSE, out.width="60%"}
knitr::include_graphics(here::here("www", "img", "New_project.png"))
```

You can also do so by clicking the project button:

```{r, echo = FALSE, out.width="60%"}
knitr::include_graphics(here::here("www", "img", "project_button.png"))
```

See [here](https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects) to learn more about using RStudio projects. 

</details>
<hr style="height:1px;border:none;color:#333;background-color:#333;" />
</details>

####

Luckily, our data is already in pretty good shape, but we want to make our data more useful for our dashboard. 

Let's shorten the name of the data that was wrangled up to the last step for the map. We will use `shooting_data`.

```{r}
shooting_data <-shooting_data_wrangled_pre_map
```

We will also rename the data that is wrangled for the map to a shorter name:

```{r}
shooting_data_for_map <- shooting_data_wrangled_for_map
```

Let's double check that our data is expected:

```{r}
dim(shooting_data)
dim(shooting_data_for_map)
```

Great, looks like we indeed have more rows in our `shooting_data` as we would expect.

There are several elements we would like to include in our dashboard.

One thing we would like is an interactive table.

## **Interactive Table**
***
We can do this using the `datatable()` function from the `DT` package.

```{r, eval = FALSE}
DT::datatable(shooting_data)
```
This creates a searchable table and the order in which the data is displayed can be toggled to change for each variable.

However, we have many variables or columns in our dataset, so this can be overwhelming. Instead of displaying all of the variables, let's choose only some of the most interesting to display in our dashboard.

<!-- ```{r} -->
<!-- DT_table <- -->
<!--   shooting_data %>% -->
<!--   dplyr::select(Date, -->
<!--                 School, -->
<!--                 City, -->
<!--                 State, -->
<!--                 `Killed (includes shooter)`, -->
<!--                 `Narrative (Detailed Summary/ Background)`) %>% -->
<!--   rename("Deaths" = `Killed (includes shooter)`) %>% -->
<!--   rename("Narrative" = `Narrative (Detailed Summary/ Background)`) -->

<!-- DT::datatable(DT_table) -->
<!-- ``` -->

Next, we will make some data visualizations.

## **Yearly Shootings**
***

We would like to create a plot of the number of school shootings per year.

To do this, we will count the number of school shootings per year using the `count()` function from the `dplyr` package. We specify that we want to count the unique values of the `Date_year` variable and name the new column `Shootings`.


```{r}
shootings_per_year <-
  shooting_data %>%
  count(Date_year, name = "Shootings")

shootings_per_year
```

Good, this looks as expected.

Now to make a plot of this data we will use the `ggplot2` package.

#### {.click_to_expand_block}

<details><summary> Click here for an introduction to `ggplot2`. </summary>

The [ggplot2 package](http://ggplot2.tidyverse.org) is generally intuitive for beginners because it is based on a  [grammar of graphics](http://vita.had.co.nz/papers/layered-grammar.html) or the `gg` in `ggplot2`.
The idea is that you can construct many sentences by learning just a few nouns, adjectives, and verbs. There are specific “words” that we will need to learn and once we do, you will be able to create (or “write”) hundreds of different plots.

The critical part to making graphics using `ggplot2` is the data needs to be in a _tidy_ format.
Given that we have just spent time putting our data in _tidy_ format, we are primed to take advantage of all that `ggplot2` has to offer!

We will show how it is easy to pipe _tidy_ data (output) as input to other functions that create plots.
This all works because we are working
within the _tidyverse_.

**What is the `ggplot()` function?**
As explained by Hadley Wickham:

> The grammar tells us that a statistical graphic is a mapping from data to aesthetic attributes (colour, shape, size) of geometric objects (points, lines, bars). The plot may also contain statistical transformations of the data and is drawn on a specific coordinates system.

`ggplot2` Terminology:

- **ggplot** - the main function where you specify the dataset and variables to plot (this is where we define the `x` and
`y` variable names)
- **geoms** - geometric objects
    - e.g. `geom_point()`, `geom_bar()`, `geom_line()`, `geom_histogram()`
- **aes** - aesthetics
    - shape, transparency, color, fill, line types
- **scales** - define how your data will be plotted
    - continuous, discrete, log, etc

The function `aes()` is an aesthetic mapping function inside the `ggplot()` object.
We use this function to specify plot attributes (e.g. `x` and `y` variable names) that will not change as we add more layers.

Anything that goes in the `ggplot()` object becomes a global setting.
From there, we use the `geom` objects to add more layers to the base `ggplot()` object.
These will define what we are interested in illustrating using the data.

</details>

####

***
For more of an introduction on creating plots with `ggplot2` , see this [case study](https://opencasestudies.github.io/ocs-bp-co2-emissions/)

***

First, we start with the `ggplot()` function from the `ggplot2` package.

This function requires that the aesthetics `aes()` be specified. This involves choosing what variable will be plotted on the x-axis and the y-axis.

```{r}
shootings_per_year %>%
    ggplot(aes(x = Date_year, y = Shootings))
```

Using the `ggplot()` function alone will create an empty plot area. To make our plot not empty, we need to select one of the `geom_*` functions of the `ggplot2` package to specify what type of plot we want to create.

Assuming the `ggplot2` library is loaded, type `geom` into the RStudio console and you will see many options to scroll through.

Here, we use a `geom_col()` plot, which is a particular type of bar plot that uses the actual values to plot, rather than counts, which is the default of `geom_bar()`. We will specify with the `fill` argument, that we want our bars to be filled with the color black.

```{r}
shootings_per_year %>%
    ggplot(aes(x = Date_year, y = Shootings)) +
    geom_col(fill = "black")
```

We also modify the x-axis using the `scale_x_continuous()` function. This function allows for specification of the range or limits of the axis using the `limits` argument. We can use the base `seq()` function to create a sequence of numbers for each tick mark.

We can add labels to our plot using the `labs()` function from `ggplot2`. This has arguments such as `x` and `y` for the axes and `title` and `subtitle` for titles. We can use `NULL` to remove a label. For example to remove the x-axis label we can use `x = NULL`

We will also modify the overall aesthetics of the plot using a `theme_*` function. See [here](https://ggplot2.tidyverse.org/reference/ggtheme.html) for a list of options.

```{r}
start <- 1970
end <- 2020

shootings_per_year_p <-
  shootings_per_year %>%
    ggplot(aes(x = Date_year, y = Shootings)) +
      geom_col(fill = "black") +
      scale_x_continuous(breaks = seq(start, end, by = 5),
                         labels = seq(start, end, by = 5),
                         limits = c(start-1, end+1)) +
      theme_minimal() +
      labs(title = "Yearly School Shootings",
           subtitle = "United States",
           x = NULL,
           y = "School Shootings")

shootings_per_year_p
```

## **Yearly Deaths**
***

Let's make a similar plot for the number of deaths

```{r}
deaths_per_year<-
  shooting_data %>%
  group_by(Date_year) %>%
  summarize(Deaths = sum(`Killed (includes shooter)`))

deaths_per_year_p <-
  deaths_per_year %>%
    ggplot(aes(x = Date_year, y = Deaths)) +
      geom_col(fill = "black") +
      scale_x_continuous(breaks = seq(start, end, by = 5),
                         labels = seq(start, end, by = 5),
                         limits = c(start-1, end+1)) +
      theme_minimal() +
      labs(title = "Yearly Deaths Attributable to School Shootings",
           subtitle = "United States",
           x = NULL)

deaths_per_year_p
```

**Note**: When using the `summarize()` function, we don't need to use the `mutate()` function here.

Next, for the purposes of the dashboard, we actually want to create just one plot that shows both the number of school shootings per year and the number of deaths.

We can do so by combining our `shootings_per_year` and  `deaths_per_year` tibbles together and making what is called a faceted plot, using the `facet_wrap()` function to create two plots next to one another.

To combine our data we will use the `full_join()` function from the `dplyr` package. This maintains all values from both tibbles.

To do so we will be making our table "longer", meaning that it will have fewer columns and more rows.
See [here](https://en.wikipedia.org/wiki/Wide_and_narrow_data) for more information about different table formats, typically referred to as wide and long or sometimes narrow.

We will use the `pivot_longer()` function from the `tidyr` package to change the shape of our table.

There are 3 main arguments in this function:

1. `cols` - which specifies what columns to collapse
2. `names_to` - which specifies the name of the new column that will be created that will contain the column names of the columns you are collapsing
3. `values_to` - which specifies the name of the new column that will be created that will contain the values from the columns you are collapsing

To specify that we want to collapse all the columns that have year values, we can choose all those except the `Date_year` variable by using the `-` negative operator.

```{r}
per_year <-
  full_join(shootings_per_year, deaths_per_year)

per_year %<>%
  pivot_longer(cols = -Date_year,
               values_to = "events",
               names_to = "id")

per_year
```

Hmmm, we see the data type of the `id` column is a character (`<chr>`). Let's convert it to a factor, so that the order in which `Shootings` and `Deaths` appear is the order in which they appear first rather than by alphabetical order (which is default).

Using the `fct_inorder()` function from the `forcats` package, we can easily reorder the `id` variable`.

```{r}
per_year %<>%
  mutate(id = forcats::fct_inorder(id))

per_year
```

Now since we the new variable for the names is called `id` we will use this as the variable to create the facet like so: `facet_wrap(~id)`. We can also specify that we want both plots to have their own y-axis with the `scales = "free"` argument. This causes each to have the y-axis automatically scaled for the data in each plot. We can then use the  `scale_y_continuous()` function to set both of the y-axes to be the same.

```{r}
per_year %>%
  ggplot(aes(x = Date_year, y = events, fill =id)) +
    geom_col() +
    facet_wrap(~id, scales = "free") +
    scale_x_continuous(breaks = seq(start, end, by = 5),
                       labels = seq(start, end, by = 5),
                       limits = c(start-1, end+1)) +
    scale_y_continuous(breaks = seq(0, 120, by = 30),
                       labels = seq(0, 120, by = 30),
                       limits = c(0, 121))+
    theme_minimal() +
    labs(title = "Yearly Shootings and Deaths Attributable to School Shootings",
         subtitle = "United States",
         y = "Number of events",
         x = "Year")+
    scale_fill_manual(values = c("black", "black"))+
    theme(legend.position = "none",
          legend.title = element_blank(),
          axis.text.x = element_text(angle = 90),
          strip.background =element_rect(fill="cornflowerblue"),
          strip.text = element_text(colour = 'white', face = "bold", size = 14))
```

Next, we can modify the plot further so that it is more obvious what each plot is showing. We can update the names of the y-axis for each plot by changing the `strip.position` argument of the `facet_wrap()` function to be placed on the left rather than above. Currently it is the label in blue that says what the value of the `id` variable is for each plot. This also requires some modification of the `theme()` function to place the `strip.text` outside the plot area and to remove the background.Furthermore, we also change the text using the `labeller` argument of the `facet_wrap()` function. The `as_labeller()` function from the `ggplot2` package can change out the `id` values for other text like in the following code:

```{r}
per_year %>%
  ggplot(aes(x = Date_year, y = events, fill =id)) +
    geom_col() +
    facet_wrap(~id,
               scales = "free",
               labeller = as_labeller(c(Shootings = "Shootings (# of events)",
                                        Deaths = "Deaths (# of people)")),
               strip.position = "left") +
    scale_x_continuous(breaks = seq(start, end, by = 5),
                       labels = seq(start, end, by = 5),
                       limits = c(start-1, end+1)) +
    scale_y_continuous(breaks = seq(0, 120, by = 30),
                       labels = seq(0, 120, by = 30),
                       limits = c(0, 121))+
    theme_minimal() +
    labs(title = "Yearly Shootings and Deaths Attributable to School Shootings",
         subtitle = "United States",
         y = NULL,
         x = "Year")+
    scale_fill_manual(values = c("black", "black"))+
    theme(legend.position = "none",
          legend.title = element_blank(),
          axis.text.x = element_text(angle = 90),
          strip.background = element_blank(),
          strip.placement = "outside",
          strip.text = element_text(face = "bold", size = 14))
```

Good,  Now this is much easier to interpret.

Our last step in this section is to save the style settings of this plot as theme so we can reuse it for future plots. To do this, we use the base `function()` function:

```{r}
theme_dashboard <- function(){
  theme(legend.position = "none",
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, face = "bold"),
        axis.title.x = element_text(face = "bold", size = 14),
        strip.background = element_blank(),
        strip.placement = "outside",
        strip.text = element_text(face = "bold", size = 14))
}
```



## **Yearly Cumulative Shootings**
***

Now let's make another plot of the cumulative deaths each year including those of the previous years. In this case we can use the `shootings_per_year` object that we previously made.

```{r}
shootings_per_year
```

However, we want to add a new variable using the `mutate` function called `n_cum_sum` by using the `cumsum()` function to calculate a cumulative sum based on the yearly count.

```{r}
shootings_per_year_cum <- shootings_per_year%>%
    mutate(Shootings = cumsum(Shootings))

deaths_per_year_cum <- deaths_per_year%>%
    mutate(Deaths = cumsum(Deaths))

shootings_per_year_cum
```

Next, we join these tables together

```{r}
per_year_cum <-
  full_join(shootings_per_year_cum, deaths_per_year_cum)

per_year_cum %<>%
  pivot_longer(cols = c(Shootings,Deaths ),
               values_to = "events",
               names_to = "id")

per_year_cum
```

Good, this looks like we would expect.

Now let's make a plot like we did before:

```{r}
per_year_cum %<>%
  mutate(id = forcats::fct_inorder(id))

per_year_cum %>%
    ggplot(aes(x = Date_year, y = events, fill = id)) +
      geom_col() +
      facet_wrap(~id, scales = "free",
                 labeller = as_labeller(c(Shootings = "Shootings (# of events)",
                                          Deaths = "Deaths (# of people)")),
                 strip.position = "left") +
      scale_x_continuous(breaks = seq(start, end, by = 5),
                         labels = seq(start, end, by = 5),
                         limits = c(start-1, end+1)) +
      scale_y_continuous(breaks = seq(0, 1500, by = 500),
                         labels = seq(0, 1500, by = 500),
                         limits = c(0, 1500)) +
      theme_minimal() +
      labs(title = "Cumulative Yearly Shootings and Deaths\nAttributable to School Shootings",
           subtitle = "United States",
           y = NULL,
           x = "Year") +
      scale_fill_manual(values = c("black", "black")) +
      theme_dashboard()
```

**Note**: the limits for the y-axis were determined by first plotting without the `scale_y_continuous()` function.



## **Deaths per Shooting**
***

Next, we will make a plot of the number of deaths per school shooting based on the `Killed (includes shooter)` variable. 

#### {.recall_code_question_block}

<b><u> Question Opportunity </u></b>

See if you can come up with the code for the plot.

```{r, echo=FALSE}
save(shooting_data, file = here::here("www", "exercise", "dav_code1.rda"))
```

```{r dav_code1-setup}
library(tidyverse)
library(magrittr)

load(here::here("www", "exercise", "dav_code1.rda"))
```

```{r dav_code1, exercise=TRUE}
deaths_per_event <-
  shooting_data %>%

per_shooting_plot <- deaths_per_event %>%


```

```{r dav_code1-hint-1}
deaths_per_event <-
  shooting_data %>%
  group_by(`Killed (includes shooter)`) %>%
  count() %>%
  ungroup()

per_shooting_plot <- deaths_per_event %>%

```

```{r dav_code1-hint-2}
deaths_per_event <-
  shooting_data %>%
  group_by(`Killed (includes shooter)`) %>%
  count() %>%
  ungroup()

per_shooting_plot <- deaths_per_event %>%
  ggplot(aes(y = `Killed (includes shooter)`, x = n)) +
    geom_col(fill = "black") +

```

```{r dav_code1-solution}
deaths_per_event <-
  shooting_data %>%
  group_by(`Killed (includes shooter)`) %>%
  count() %>%
  ungroup()

per_shooting_plot <- deaths_per_event %>%
  ggplot(aes(y = `Killed (includes shooter)`, x = n)) +
    geom_col(fill = "black") +
    theme_minimal() +
    labs(title = "Deaths per School Shooting",
         subtitle = "United States",
         x = "School Shootings",
         y = "")
```


***

<details> <summary> Click here to reveal the answer. </summary>


```{r}
deaths_per_event <-
  shooting_data %>%
  group_by(`Killed (includes shooter)`) %>%
  count() %>%
  ungroup()

per_shooting_plot <- deaths_per_event %>%
  ggplot(aes(y = `Killed (includes shooter)`, x = n)) +
    geom_col(fill = "black") +
    theme_minimal() +
    labs(title = "Deaths per School Shooting",
         subtitle = "United States",
         x = "School Shootings",
         y = "")
```

</details>

***

####

***

#### {.recall_code_question_block}
<b><u> Question Opportunity </u></b>

Let's take a minute to test your knowledge about `flexdashboard` basics: 

####

```{r dashbasics_quiz, echo = FALSE}
quiz(caption = "",
  question("How do we create multiple pages?",
    answer("The `---` syntax", message = "This is for multiple columns."),
    answer("The `{.tabset}` syntax combined with `---`", message = "This is for multiple tabs."),
    answer("Create an R Markdown document and add `output: flexdashboard::flexdashboard` to the YAML", message = "This is how to start creating a dashboard."),
    answer("Add `runtime:shiny` to the YAML", message = "This is how to enable the dashboard to be interactive."),
    answer("The `===` syntax", correct = TRUE),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How do we create multiple columns?",
    answer("The `---` syntax", correct = TRUE),
    answer("The `{.tabset}` syntax combined with `---`", message = "This is for multiple tabs."),
    answer("Create an R Markdown document and add `output: flexdashboard::flexdashboard` to the YAML", message = "This is how to start creating a dashboard."),
    answer("Add `runtime:shiny` to the YAML", message = "This is how to enable the dashboard to be interactive."),
    answer("The `===` syntax", message = "This is for multiple pages."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How do we create multiple tabs?",
    answer("The `---` syntax", message = "This is for multiple columns."),
    answer("The `{.tabset}` syntax combined with `---`", correct = TRUE),
    answer("Create an R Markdown document and add `output: flexdashboard::flexdashboard` to the YAML", message = "This is how to start creating a dashboard."),
    answer("Add `runtime:shiny` to the YAML", message = "This is how to enable the dashboard to be interactive."),
    answer("The `===` syntax", message = "This is for multiple pages."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How do we start creating a dashboard?",
    answer("The `---` syntax", message = "This is for multiple columns."),
    answer("The `{.tabset}` syntax combined with `---`", message = "This is for multiple tabs."),
    answer("Create an R Markdown document and add `output: flexdashboard::flexdashboard` to the YAML", correct = TRUE),
    answer("Add `runtime:shiny` to the YAML", message = "This is how to enable the dashboard to be interactive."),
    answer("The `===` syntax", message = "This is for multiple pages."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  ),
  question("How do we enable our dashboard to be interactive?",
    answer("The `---` syntax", message = "This is for multiple columns."),
    answer("The `{.tabset}` syntax combined with `---`", message = "This is for multiple tabs."),
    answer("Create an R Markdown document and add `output: flexdashboard::flexdashboard` to the YAML", message = "This is how to start creating a dashboard."),
    answer("Add `runtime:shiny` to the YAML", correct = TRUE),
    answer("The `===` syntax", message = "This is for multiple pages."),
    allow_retry = TRUE,
    random_answer_order = TRUE
  )
)
```
